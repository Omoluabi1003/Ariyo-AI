<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Ariyo AI Chatbot</title>
  <link rel="stylesheet" href="./voice.css">
  <script async type='module' src='https://interfaces.zapier.com/assets/web-components/zapier-interfaces/zapier-interfaces.esm.js'></script>
  <script src="../../viewport-height.js" defer></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      display: flex;
      min-height: var(--app-height, 100vh);
    }
    zapier-interfaces-chatbot-embed {
      flex: 1;
      height: var(--app-height, 100vh);
      width: 100%;
    }
  </style>
</head>
<body>
  <zapier-interfaces-chatbot-embed is-popup='false' chatbot-id='cm7s2oyu2000b3vmuwcwkj9kn'></zapier-interfaces-chatbot-embed>
  <div id="ariyo-voice-root"></div>
  <script>
    (function () {
      const PANEL_ID = 'ariyoChatbotContainer';
      const SOURCE = 'edge-panel-app';

      function isValidOrigin(origin) {
        if (!origin) return false;
        if (origin === 'null' || origin === 'about:blank') return false;
        return !origin.startsWith('file:');
      }

      function resolveTargetOrigin() {
        try {
          if (document.referrer) {
            const referrerOrigin = new URL(document.referrer, window.location.href).origin;
            if (isValidOrigin(referrerOrigin)) {
              return referrerOrigin;
            }
          }
        } catch (error) {
          /* ignore invalid referrer */
        }

        if (window.location) {
          try {
            const currentOrigin = window.location.origin;
            if (isValidOrigin(currentOrigin)) {
              return currentOrigin;
            }
          } catch (error) {
            /* ignore invalid current origin */
          }

          if (window.location.ancestorOrigins && window.location.ancestorOrigins.length) {
            const ancestorOrigin = window.location.ancestorOrigins[0];
            if (isValidOrigin(ancestorOrigin)) {
              return ancestorOrigin;
            }
          }
        }

        return '*';
      }

      const targetOrigin = resolveTargetOrigin();

      function postStatus(status, reason) {
        if (!window.parent || window.parent === window) return;
        const payload = { source: SOURCE, panelId: PANEL_ID, status };
        if (reason) {
          payload.reason = reason;
        }
        window.parent.postMessage(payload, targetOrigin);
      }

      function monitorEmbed() {
        if (!window.customElements || typeof window.customElements.whenDefined !== 'function') {
          postStatus('error', 'unsupported-browser');
          return;
        }

        let readyTimeout = setTimeout(() => {
          if (!window.customElements.get('zapier-interfaces-chatbot-embed')) {
            postStatus('error', 'component-unavailable');
          }
        }, 10000);

        window.customElements.whenDefined('zapier-interfaces-chatbot-embed').then(() => {
          clearTimeout(readyTimeout);
          const embed = document.querySelector('zapier-interfaces-chatbot-embed');
          if (embed) {
            postStatus('ready');
          } else {
            postStatus('error', 'missing-embed');
          }
        }).catch(() => {
          postStatus('error', 'component-unavailable');
        });
      }

      if (document.readyState === 'complete') {
        monitorEmbed();
      } else {
        window.addEventListener('load', monitorEmbed, { once: true });
      }
    })();
  </script>
  <script src="./voice.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const mountEl = document.getElementById('ariyo-voice-root');
      const embed = document.querySelector('zapier-interfaces-chatbot-embed');

      const queryDeep = (root, selector) => {
        if (!root) return null;
        const scope = root.shadowRoot || root;
        const directMatch = scope.querySelector(selector);
        if (directMatch) return directMatch;
        const nodes = scope.querySelectorAll('*');
        for (const node of nodes) {
          if (node.shadowRoot) {
            const found = queryDeep(node, selector);
            if (found) return found;
          }
        }
        return null;
      };

      const queryAllDeep = (root, selector) => {
        const results = [];
        if (!root) return results;
        const scope = root.shadowRoot || root;
        results.push(...scope.querySelectorAll(selector));
        const nodes = scope.querySelectorAll('*');
        for (const node of nodes) {
          if (node.shadowRoot) {
            results.push(...queryAllDeep(node, selector));
          }
        }
        return results;
      };

      const getInputEl = () => queryDeep(embed, 'textarea, input[type="text"], input[type="search"]');

      const setInputText = (text) => {
        const input = getInputEl();
        if (!input) return;
        input.value = text;
        input.dispatchEvent(new Event('input', { bubbles: true }));
        input.focus();
      };

      const assistantSelectors = [
        '[data-message-author="assistant"]',
        '[data-role="assistant"]',
        '[data-testid="assistant-message"]',
        '.assistant',
        '.assistant-message',
        '.message.assistant',
        '.message.bot',
        '.bot'
      ];

      const getLastAssistantText = () => {
        if (!embed) return '';
        let nodes = [];
        assistantSelectors.forEach((selector) => {
          nodes = nodes.concat(queryAllDeep(embed, selector));
        });
        if (!nodes.length) return '';
        const last = nodes[nodes.length - 1];
        return last && last.textContent ? last.textContent.trim() : '';
      };

      if (window.AriyoVoice && mountEl) {
        window.AriyoVoice.mount({
          mountEl,
          getLastAssistantText,
          setInputText,
          getInputEl
        });
      }

      let lastAssistantText = '';
      const handleAssistantNode = (node) => {
        if (!(node instanceof HTMLElement)) return;
        let assistantNode = null;
        for (const selector of assistantSelectors) {
          if (node.matches && node.matches(selector)) {
            assistantNode = node;
            break;
          }
        }
        if (!assistantNode) {
          for (const selector of assistantSelectors) {
            const found = node.querySelector ? node.querySelector(selector) : null;
            if (found) {
              assistantNode = found;
              break;
            }
          }
        }
        if (assistantNode && assistantNode.textContent) {
          const text = assistantNode.textContent.trim();
          if (text && text !== lastAssistantText) {
            lastAssistantText = text;
            if (window.AriyoVoice) {
              window.AriyoVoice.onAssistantMessage(text);
            }
          }
        }
      };

      if (embed && embed.shadowRoot) {
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach(handleAssistantNode);
          });
        });
        observer.observe(embed.shadowRoot, { childList: true, subtree: true });
      }

      setInterval(() => {
        const text = getLastAssistantText();
        if (text && text !== lastAssistantText) {
          lastAssistantText = text;
          if (window.AriyoVoice) {
            window.AriyoVoice.onAssistantMessage(text);
          }
        }
      }, 1500);
    });
  </script>
  <script src="../../scripts/sw-controller.js" defer></script>
</body>
</html>
